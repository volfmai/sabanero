

{{-- =============================================================
      UNIFIED AD COMPONENT
      (Clean Structure - No Functional Changes)
============================================================= --}}



{{-- =============================================================
      SECTION 1 — PROPS & PHP HELPERS
============================================================= --}}



@props([
    'leaderboard' => null,
    'sidebar' => null,
    'article_top_desktop' => null,
    'article_top_mobile' => null,
    'article_bottom_desktop' => null,
    'article_bottom_mobile' => null,
    'sticky_desktop' => null,
    'sticky_mobile' => null,
    'preloaders' => [],
])

@php
    $enabledStickiesDesktop = [];
    if (is_array($sticky_desktop)) {
        $enabledStickiesDesktop = array_values(array_filter($sticky_desktop, fn($s) => !empty($s['status'])));
    }

    $enabledStickiesMobile = [];
    if (is_array($sticky_mobile)) {
        $enabledStickiesMobile = array_values(array_filter($sticky_mobile, fn($s) => !empty($s['status'])));
    }

    $enabledPreloaders = array_values(array_filter($preloaders, fn($p) => !empty($p['status'])));

    if (!function_exists('renderAd')) {
        function renderAd($ad, $cssClass) {
            if (!$ad || empty($ad['status'])) return '';

            $html = '<div class="ad ' . $cssClass . '" data-banner-wrapper>';

            if (!empty($ad['code'])) {
                $html .= $ad['code'];
            } elseif (!empty($ad['image'])) {
                $url = $ad['url'] ?? '#';
                $alt = $ad['alt'] ?? 'Advertisement';
                
                $html .= '<a href="' . $url . '" class="ad-link" target="_blank" rel="nofollow sponsored">';
                $html .= '<img src="' . $ad['image'] . '" alt="' . $alt . '">';
                $html .= '</a>';
            }
            
            $html .= '</div>';
            return $html;
        }
    }
@endphp




{{-- =============================================================
      SECTION 2 — STATIC ADS (Leader / Sidebar / Article Top/Bottom)
============================================================= --}}



{{-- 1. Leaderboard (Mobile Only) --}}
@if($html = renderAd($leaderboard, 'ad-leaderboard mobile'))
    <div class="mobile-only">
        {!! $html !!}
    </div>
@endif

{{-- 2. Article Top --}}
@if($html = renderAd($article_top_desktop, 'ad-article-top'))
    <div class="desktop-only">
        {!! $html !!}
    </div>
@endif

@if($html = renderAd($article_top_mobile, 'ad-article-top'))
    <div class="mobile-only">
        {!! $html !!}
    </div>
@endif

{{-- 3. Sidebar (Desktop --}}

@if($html = renderAd($sidebar, 'ad-sidebar'))
    <div class="ad-sidebar-wrapper">
        {!! $html !!}
    </div>
@endif

{{-- 4. Article Bottom --}}
@if($html = renderAd($article_bottom_desktop, 'ad-article-bottom'))
    <div class="desktop-only">
        {!! $html !!}
    </div>
@endif

@if($html = renderAd($article_bottom_mobile, 'ad-article-bottom'))
    <div class="mobile-only">
        {!! $html !!}
    </div>
@endif




{{-- =============================================================
      SECTION 3 — STICKIES (BOTTOM FLOATING ADS)
============================================================= --}}


<div id="banner-wrapper-desktop" class="sticky-banner desktop-only" data-sticky-type="desktop">
   <div class="p-banner">
        <button class="close-trigger" aria-label="Close">
    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M18 6L6 18M6 6L18 18" stroke="black" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M18 6L6 18M6 6L18 18" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
</button>
        <div class="banner-content"></div>
    </div>
</div>

<div id="banner-wrapper-mobile" class="sticky-banner mobile-only" data-sticky-type="mobile">
    <div class="p-banner">
        <button class="close-trigger" aria-label="Close">
    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M18 6L6 18M6 6L18 18" stroke="black" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M18 6L6 18M6 6L18 18" stroke="white" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
</button>
        <div class="banner-content"></div>
    </div>
</div>



{{-- =============================================================
      SECTION 4 — PRELOADERS (FULL-SCREEN ADS)
============================================================= --}}



@foreach($enabledPreloaders as $i => $p)
    <div class="ad-preloader js-preloader"
         id="p-view-{{ $i }}"
         data-ad-id="{{ $p['id'] ?? $i }}"
         data-index="{{ $i }}"
         role="dialog"
         aria-modal="true"
         aria-hidden="true"
         tabindex="-1"
                  aria-label="Advertisement"
         style="display:none">
        
        <div class="ad-preloader-box">
            <div class="ad-timer-wrap" aria-hidden="true">
                <svg class="ad-timer-svg" viewBox="0 0 36 36">
                    <circle class="ad-timer-bg" cx="18" cy="18" r="16" fill="none"></circle>
                    <circle class="ad-timer-bar" cx="18" cy="18" r="16" fill="none"></circle>
                </svg>
            </div>

            @if(!empty($p['image']) || !empty($p['webp']))
                <a href="{{ $p['url'] ?? '#' }}" target="_blank" rel="nofollow sponsored noopener noreferrer">
                    <picture>
                        @if(!empty($p['webp']))
                            <source srcset="{{ $p['webp'] }}" type="image/webp">
                        @endif
                        <img src="{{ $p['image'] }}" class="js-ad-image" alt="{{ $p['alt'] ?? 'Advertisement' }}" loading="eager">
                    </picture>
                </a>
            @elseif(!empty($p['code']))
                <div class="ad-external-video-wrapper">
                    {!! $p['code'] !!}
                </div>
            @endif
        </div>
    </div>
@endforeach


{{-- =============================================================
      SECTION 5 — CSS
============================================================= --}}


<style>

@media (min-width: 1281px) { .mobile-only { display: none !important; } }
@media (max-width: 1280px) { .desktop-only { display: none !important; } }

.is-hidden { display: none !important; pointer-events: none !important; }



/* STICKY CORE & POSITIONING */


:root {
    --x-speed: 1.5s;
    --banner-melt: 0.8s;
    --start-delay: 0s;
}

.sticky-banner {
    position: fixed;
    bottom: env(safe-area-inset-bottom, 0);
    left: 0;
    width: 100%;
    z-index: 199999;
    pointer-events: none;
    display: none; 
    justify-content: center;
    touch-action: pan-y;
    -webkit-transform: translate3d(0, 0, 0);
    transform: translate3d(0, 0, 0);
    opacity: 0;
    transition: opacity 0.3s ease-out;

}

.sticky-banner.visible {
    display: flex !important;
    opacity: 1;
    pointer-events: auto;
}

.p-banner {
    background: #1a1a1a;
    width: 95%; 
    max-width: 1140px;
    min-height: 44px;
    height: auto;
    color: #ffffff;
    border-radius: 8px 8px 0 0 !important; 
    display: flex; 
    align-items: center; 
    justify-content: center;
    font-weight: bold; 
    pointer-events: auto;
    -webkit-backface-visibility: hidden;
    position: relative;
    will-change: transform;
    -webkit-font-smoothing: antialiased;
    
overflow: hidden !important;
    isolation: isolate !important;
    -webkit-mask-image: -webkit-radial-gradient(white, black);
}

.banner-content {
    width: 100%;
    border-radius: inherit;
    overflow: hidden !important;
    isolation: isolate;
}

.banner-content > *, 
.banner-content a, 
.banner-content img,
.p-banner img { 
    max-width: 100% !important; 
    object-fit: contain;
    display: block; 
    margin: 0 auto;
}

#banner-wrapper-desktop .p-banner img {
    max-height: 100px !important;
}


#banner-wrapper-mobile .p-banner img {
    max-height: 150px !important;
}


.close-trigger {
    position: absolute;
    top: 8px;
    right: 8px;
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    background: transparent;
    border: none;
    padding: 0;
    z-index: 1001;
}

.close-trigger svg {
    width: 36px;
    height: 36px;
    display: block;
    transform: scale(1);
    opacity: 1;
}


@media screen and (max-width: 767px) {
    .close-trigger {
        width: 34px;
        height: 34px;
        top: 4px;
        right: 4px;
        outline: none;
        -webkit-tap-highlight-color: transparent;

    }

.p-banner {
        min-height: 34px !important;
    }

    .close-trigger svg {
        width: 26px;
        height: 26px;
        transform: scale(1);
        opacity: 1;
    }
}

.close-trigger.animate-shrink svg {
    animation: blowShrink var(--x-speed) cubic-bezier(0.2, 0.7, 0.1, 1) forwards !important;
}

@keyframes blowShrink {
    0% { transform: scale(1); opacity: 1; }
    100% { transform: scale(0.7); opacity: 0; }
}

.sticky-banner.removing {
    opacity: 0 !important;
    pointer-events: none;
    transition: opacity var(--banner-melt) ease-in-out !important;
}

.flick-up { 
    transform: translate3d(0, -65px, 0) !important;
    transition: transform 0.2s ease-out !important;
}
.flick-down { 
    transform: translate3d(0, 50%, 0) !important;
    transition: transform 0.2s ease-out !important;
}

.sticky-banner.in-footer {
    opacity: 0;
    transform: translateY(35px);
    pointer-events: none;
    transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
}

.sticky-banner.returning {
    opacity: 1;
    transform: translateY(0);
    transition: transform 0.3s ease, opacity 0.3s ease;
}


/* 5. PRELOADER */


.ad-preloader {
    position: fixed;
    top: 0; 
    left: 0;
    width: 100vw;
    height: 100dvh;
    z-index: 200000;
    display: none;
    align-items: center;
    justify-content: center;
    padding: calc(env(safe-area-inset-top, 0px) + 30px) 30px calc(env(safe-area-inset-bottom, 0px) + 30px) 30px;
    box-sizing: border-box;
    opacity: 0;
    transition: opacity 0.3s ease, visibility 0.3s;
    pointer-events: none;
    isolation: isolate;
    outline: none;
}

.ad-preloader.visible {
    opacity: 1;
    display: flex !important;
    pointer-events: auto;
}

@media(min-width:1281px) { 
    .ad-preloader { display: none !important; } 
}

.ad-preloader-box {
    position: relative;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background: #1a1a1a;
    border-radius: 8px;
    overflow: hidden !important;
    isolation: isolate;
    max-width: 100%;
    max-height: 100%;
}

.ad-preloader-box img, .ad-preloader-box video {
    display: block;
    width: auto;
    height: auto;
    max-width: 100%;
    max-height: 100%;
    opacity: 0;
    transition: opacity 0.3s ease;
    object-fit: contain;
}

.ad-preloader-box img.loaded, .ad-preloader-box video.loaded { 
    opacity: 1 !important; 
}

.ad-timer-wrap {
    position: absolute;
    top: 10px;
    right: 10px;
    left: auto;
    width: 34px; 
    height: 34px;
    z-index: 10;
    background: transparent; 
    border-radius: 50%;
    display: flex; 
    align-items: center; 
    justify-content: center;
    line-height: 0 !important;
    transform: none;
    transition: none;
}

.ad-timer-wrap.is-centered { 
    top: 50% !important; 
    left: 50% !important;
    right: auto !important; 
}

.ad-timer-svg { 
    transform: rotate(-90deg); 
    width: 30px; 
    height: 30px; 
}

.ad-timer-bg { 
    fill: none; 
    stroke: #475569;
    stroke-width: 3; 
}

.ad-timer-bar { 
    fill: none; 
    stroke: #fff; 
    stroke-width: 3; 
    stroke-dasharray: 101; 
    stroke-dashoffset: 101;
    will-change: stroke-dashoffset;
}

@-webkit-keyframes fillTimer { 
    from { stroke-dashoffset: 101; }
    to { stroke-dashoffset: 0; }
}

@keyframes fillTimer { 
    from { stroke-dashoffset: 101; }
    to { stroke-dashoffset: 0; }
}

@media (max-height: 600px) { 
    .ad-timer-wrap { width: 38px; height: 38px; top: 10px; right: 10px; } 
    .ad-timer-svg { width: 34px; height: 34px; } 
}


/* ========================================
   STATIC ADS INSURANCE
   ======================================== */

.ad img, .ad iframe, .ad ins {
    width: 100% !important;   
        max-width: 100% !important; 
    height: auto !important;   
    display: block;
    margin: 0 auto;

}

@media (max-width: 1280px) {

    .ad.ad-article-top,
    .ad.ad-article-bottom,
    .ad.ad-leaderboard,
    .ad.ad-sidebar {
        width: 100%;           
        margin: 0 0 20px 0;
        overflow: hidden;      

    }
}

@media (min-width: 1281px) {
    .ad.ad-article-top,
    .ad.ad-article-bottom {
        width: 100%;           
        margin: 20px 0 40px 0;
        overflow: hidden;

    }

    .ad.ad-sidebar {
        width: 100%;
        max-width: 336px;      
        margin: 20px 0;
        overflow: hidden;

    }
}

/* ========================================
   PRELOADER IMAGE - საზღვრების დაცვა
   ======================================== */

.ad-preloader .ad-preloader-box img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

</style>



{{-- =============================================================
      SECTION 6 — JavaScript
============================================================= --}}

<script>


document.addEventListener('DOMContentLoaded', () => {

    // --- RESET BLOCK ---

    const resetSticky = (id) => {
        const el = document.getElementById(id);
        if (el) {
            el.style.display = 'none';
            el.classList.remove('visible', 'in-footer', 'returning', 'removing');
            delete el.dataset.initialized;
        }
    };
    resetSticky('banner-wrapper-desktop');
    resetSticky('banner-wrapper-mobile');

    const TIMING = {
        STICKY_SHOW_DELAY: 3000,
        PRELOADER_AUTO_CLOSE: 5000,
        MOBILE_SAFETY_LIMIT: 10000,
        FLICK_DURATION: 700,
        FLICK_FAST: 500,
        GESTURE_LOCK: 800,
    };

const isDev = window.location.hostname === 'localhost' || window.location.hostname.includes('127.0.0.1');
const trackImpression = window.trackImpression || (isDev ? (t, i) => console.log(`Impression: ${t} #${i}`) : () => {});
const trackClick = window.trackClick || (isDev ? (t, i) => console.log(`Click: ${t} #${i}`) : () => {});

const footer = document.getElementById('footer') || document.querySelector('footer');

const initSticky = (wrapperId, stickyData) => {
    const bannerWrapper = document.getElementById(wrapperId);
    if (!bannerWrapper) return;

    if (bannerWrapper.dataset.initialized) return;
    bannerWrapper.dataset.initialized = 'true';

    const contentContainer = bannerWrapper.querySelector('.banner-content');
    const banner = bannerWrapper.querySelector('.p-banner');
    const closeBtn = bannerWrapper.querySelector('.close-trigger');

    if (!contentContainer || !banner || !closeBtn || !stickyData || stickyData.length === 0) return;

    let s = null;

    try {
        let idx = sessionStorage.getItem('sticky-last-' + wrapperId);
        const lastIdx = parseInt(idx, 10);
        idx = !isNaN(lastIdx)
            ? (lastIdx + 1) % stickyData.length
            : Math.floor(Math.random() * stickyData.length);

        sessionStorage.setItem('sticky-last-' + wrapperId, idx);

        s = stickyData[idx];
        if (!s || (!s.code && !s.image && !s.image_mobile)) return;

        const isMobile = window.innerWidth <= 1280;

        if (s.code) {
            contentContainer.innerHTML = s.code;
        } else {
            const img = isMobile ? (s.image_mobile || s.image) : s.image;
            if (!img) return;

                 const rawLink = isMobile ? (s.url_mobile || s.url || '#') : (s.url || '#');
                 const safeLink = /^https?:\/\//i.test(rawLink) ? rawLink : '#';

                 contentContainer.innerHTML = `
            <a href="${safeLink}" target="_blank" rel="nofollow sponsored" style="display:block; width:100%;">
        <img src="${img}" alt="Ad" style="display:block;">
            </a>`;

        }

    } catch (e) {
        console.error('Sticky content error:', e);
        return;
    }

        let shown = false;
        let isClosing = false;
        let isMoving = false;
        let flickDisabled = false;
        let gestureLocked = false;
        let footerObserver = null;
        let lastScrollY = window.scrollY;
        let activeFlickId = 0;


const pageLoadTime = Date.now();

const showNow = () => {
    if (shown || isClosing) return;
    shown = true;
        window.removeEventListener('scroll', onScroll);
    bannerWrapper.style.display = 'flex';
    trackImpression(bannerWrapper.dataset.stickyType, s.id);
    requestAnimationFrame(() => requestAnimationFrame(() => {
        bannerWrapper.classList.add('visible');
    }));
};

const onScroll = () => {
    if (Date.now() - pageLoadTime < 1000) return;
    const currentY = window.scrollY;
    const scrollDifference = Math.abs(currentY - lastScrollY);
    if (currentY > 100 && scrollDifference > 30) {
        showNow();
    }

    lastScrollY = currentY;
};

      window.addEventListener('scroll', onScroll, { passive: true });

// 3 Second Timer

const autoShowTimer = setTimeout(() => {
            showNow();

        }, TIMING.STICKY_SHOW_DELAY);

        if (footer) {
            footerObserver = new IntersectionObserver(entries => {
                if (entries[0].isIntersecting) {
                    bannerWrapper.classList.add('in-footer');
                    bannerWrapper.classList.remove('returning');
                } else {
                    bannerWrapper.classList.remove('in-footer');
                    bannerWrapper.classList.add('returning');
                    setTimeout(() => {
                        if (bannerWrapper) bannerWrapper.classList.remove('returning');
                    }, 300);
                }
            }, { threshold: 0.1 });
            footerObserver.observe(footer);
        }

        const runFlick = (cls, delay) => {
            if (isMoving || flickDisabled || isClosing || !shown) return;
            isMoving = true;
            banner.classList.add(cls);

            if (window.innerWidth <= 1280) {
                isMoving = false;
                const flickId = ++activeFlickId;

                let scrollStopTimer = null;

                function forceReset() {
                    if (flickId !== activeFlickId) return;
                    clearTimeout(scrollStopTimer);
                    window.removeEventListener('scroll', onScrollTick);
                    banner.classList.remove('flick-up', 'flick-down');
                                        isMoving = false;
                }

                function onScrollTick() {
                    const st = window.pageYOffset || document.documentElement.scrollTop;
                    const isFlickUp = banner.classList.contains('flick-up');
                    const isFlickDown = banner.classList.contains('flick-down');

                    if ((isFlickUp && st < lastScrollTop - 50) || (isFlickDown && st > lastScrollTop + 50)) {
                        lastScrollTop = st;
                        // მიმართულება შეიცვალა — ახალ class-ს ვადებთ
                        banner.classList.remove('flick-up', 'flick-down');
                        if (isFlickUp) banner.classList.add('flick-down');
                        else banner.classList.add('flick-up');
                        clearTimeout(scrollStopTimer);
                        scrollStopTimer = setTimeout(forceReset, 250);
                        return;
                    }

                    lastScrollTop = st <= 0 ? 0 : st;
                    clearTimeout(scrollStopTimer);
                    scrollStopTimer = setTimeout(forceReset, 250);
                }

                setTimeout(() => {
                    lastScrollTop = window.pageYOffset || document.documentElement.scrollTop;
                    window.addEventListener('scroll', onScrollTick, { passive: true });
                }, 300);
                scrollStopTimer = setTimeout(forceReset, 800);
            } else {
                setTimeout(() => {
                    banner.classList.remove(cls);
                    setTimeout(() => { isMoving = false; }, 100);
                }, delay || 500);
            }
        };

        const onWheel = e => {
            if (bannerWrapper && bannerWrapper.contains(e.target)) return;
            if (gestureLocked || isClosing || !shown || isMoving) return;
            if (Math.abs(e.deltaY) > 200) {
                gestureLocked = true;
                runFlick(e.deltaY > 0 ? 'flick-down' : 'flick-up', TIMING.FLICK_FAST);
                setTimeout(() => gestureLocked = false, TIMING.GESTURE_LOCK);
            }
        };

        let touchStartY = 0, touchStartTime = 0;
        let lastScrollTop = window.pageYOffset || document.documentElement.scrollTop;

        const onTouchStart = e => {
            touchStartY = e.touches[0].pageY;
            touchStartTime = performance.now();
        };

        const onTouchEnd = e => {
            if (gestureLocked || isClosing || !shown || isMoving) return;
            const diff = e.changedTouches[0].pageY - touchStartY;
            const velocity = Math.abs(diff) / (performance.now() - touchStartTime || 1);
            if (velocity > 0.2 && Math.abs(diff) > 30) {
                gestureLocked = true;
                runFlick(diff < 0 ? 'flick-up' : 'flick-down');
                setTimeout(() => gestureLocked = false, TIMING.GESTURE_LOCK);
            }
        };

        window.addEventListener('wheel', onWheel, { passive: true });
        window.addEventListener('touchstart', onTouchStart, { passive: true });
        window.addEventListener('touchend', onTouchEnd, { passive: true });

        // Close Logic

        const closeBanner = e => {
            if (e) e.preventDefault();
            if (isClosing) return;
                        activeFlickId++;
            isClosing = true;
            flickDisabled = true;
            trackClick(bannerWrapper.dataset.stickyType, s.id);

            window.removeEventListener('scroll', onScroll);
            window.removeEventListener('wheel', onWheel);
            window.removeEventListener('touchstart', onTouchStart);
            window.removeEventListener('touchend', onTouchEnd);
            clearTimeout(autoShowTimer);

            if (footerObserver) {
                footerObserver.disconnect();
                footerObserver = null;
            }

            const rootStyles = getComputedStyle(document.documentElement);
            const startDelay = (parseFloat(rootStyles.getPropertyValue('--start-delay')) || 0) * 1000;
            const meltTime = (parseFloat(rootStyles.getPropertyValue('--banner-melt')) || 0.8) * 1000;

            closeBtn.classList.add('animate-shrink');

            setTimeout(() => {
                if (bannerWrapper) {
                    bannerWrapper.classList.add('removing');
                    setTimeout(() => {
                        if (bannerWrapper && bannerWrapper.parentNode) bannerWrapper.remove();
                    }, meltTime + 100);
                }
            }, startDelay);
        };

        closeBtn.addEventListener('click', closeBanner);
        bannerWrapper.addEventListener('cleanup-event', () => closeBanner());
    };


    // Decision Logic

const isDesktop = window.innerWidth >= 1281;

if (isDesktop) {
    const desktopStickies = @json($enabledStickiesDesktop ?? []); 
    if (desktopStickies.length > 0) {
        initSticky('banner-wrapper-desktop', desktopStickies);
    }
} else {
    const mobileStickies = @json($enabledStickiesMobile ?? []); 
    let stickyStarted = false;
    const startStickyMobile = () => {
        if (stickyStarted || mobileStickies.length === 0) return;
        stickyStarted = true;
        clearTimeout(safetyTimer);
        initSticky('banner-wrapper-mobile', mobileStickies);
    };
    
    let safetyTimer = setTimeout(startStickyMobile, TIMING.MOBILE_SAFETY_LIMIT);
    window.addEventListener('preloaderClosed', startStickyMobile, { once: true });
}


// PRELOADER LOGIC


const preloaders = [...document.querySelectorAll('.js-preloader')];

if (preloaders.length && window.matchMedia("(max-width: 1280px)").matches) {
    const now = Date.now();
    const lastShown = parseInt(localStorage.getItem('p_last_time') || '0', 10);
    const COOLDOWN = 45000;
    const isFirstVisit = lastShown === 0;
    const cooldownPassed = (now - lastShown >= COOLDOWN);

    if (isFirstVisit || (cooldownPassed && Math.random() > 0.3)) {
        const idx = Math.floor(Math.random() * preloaders.length);
        const el = preloaders[idx];
        const img = el.querySelector('.js-ad-image');
        const isExternal = el.querySelector('.ad-external-video-wrapper');

        if (el) {
            const tBar = el.querySelector('.ad-timer-bar');
            el.setAttribute('aria-hidden', 'false');
            el.classList.add('visible');
            el.focus();

            const hideP = (elem) => {
                if (!elem || !elem.classList.contains('visible')) return;
                localStorage.setItem('p_last_time', Date.now().toString());
                window.dispatchEvent(new CustomEvent('preloaderClosed'));
                elem.classList.remove('visible');
            };

            if (tBar) {
                tBar.style.webkitAnimation = 'none';
                tBar.style.animation = 'none';
                tBar.style.strokeDashoffset = '101';
                const duration = TIMING.PRELOADER_AUTO_CLOSE;
                const startTime = performance.now();
                
                function animate(currentTime) {
                    const elapsed = currentTime - startTime;
                    const progress = Math.min(elapsed / duration, 1);
                    tBar.style.strokeDashoffset = 101 - (progress * 101);
                    if (progress < 1) {
                        requestAnimationFrame(animate);
                    } else {
                        hideP(el);
                    }
                }

                requestAnimationFrame(animate);
            }

            if (img) {
                img.onerror = () => { img.style.display = 'none'; };
                img.onload = () => { requestAnimationFrame(() => img.classList.add('loaded')); };
                if (img.complete) img.onload();
            }

            if (isExternal) {
                window.addEventListener('externalAdStarted', () => hideP(el), { once: true });
            }

            const realAdId = el.dataset.adId || el.id;
            if (typeof trackImpression === 'function') trackImpression('preloader', realAdId);
            el.querySelector('a')?.addEventListener('click', () => {
                if (typeof trackClick === 'function') trackClick('preloader', realAdId);
            });
        }
    } else {
        window.dispatchEvent(new CustomEvent('preloaderClosed'));
    }
} else {
    window.dispatchEvent(new CustomEvent('preloaderClosed'));
}


    // BANNER CLEANUP


setTimeout(() => {
    const targets = document.querySelectorAll('[data-banner-wrapper], .ad-preloader');

    targets.forEach(el => {
        const rootTags = ['BODY', 'HTML', 'HEAD', 'MAIN', 'HEADER', 'FOOTER'];
        if (rootTags.includes(el.tagName)) return;

        const cleanupIfBroken = () => {
            const imgs = Array.from(el.querySelectorAll('img'));
            const hasPotentialImg = imgs.some(img => {
                const isLoadedSuccessfully = img.complete && img.naturalHeight > 2;
                const isStillLoading = !img.complete;
                return isLoadedSuccessfully || isStillLoading;
            });

            const hasIframe = !!el.querySelector('iframe');
            const hasVideo  = !!el.querySelector('video');
            const hasIns    = !!el.querySelector('ins');
            const hasText   = el.textContent.trim().length > 20;

            if (hasPotentialImg || hasIframe || hasVideo || hasIns || hasText) return;

            el.dispatchEvent(new CustomEvent('cleanup-event'));
            if (el.parentNode) {
                if (typeof isDev !== 'undefined' && isDev) {
                    console.warn('Ad block cleanup: empty or broken content removed.', el);
                }
                el.remove();
            }
        };

        const media = el.querySelectorAll('img, iframe, video');

        if (media.length > 0) {
            let pending = media.length;
            const checkMedia = () => {
                pending--;
                if (pending <= 0) cleanupIfBroken();
            };

            media.forEach(item => {
                if (item.tagName === 'IMG') {
                    if (item.complete) checkMedia();
                    else {
                        item.addEventListener('load', checkMedia, { once: true });
                        item.addEventListener('error', checkMedia, { once: true });
                    }
                } else {
                    checkMedia();
                }
            });
        } else {
            cleanupIfBroken();
        }
    });

}, 17000);

});
</script>


